<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Screen Saver</title>
  <link rel="icon" type="image/png" href="/favicon.png" />
  <style>
    html,body{
      height:100%;
      margin:0;
      background:#000;
      color:#fff;
      font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-user-select:none;
      user-select:none;
    }
    #hint{
      position:fixed;
      left:12px;
      bottom:12px;
      color:#888;
      font-size:12px;
      opacity:0.9;
    }
  </style>
</head>
<body>
  <div id="hint">Saving your screen from falling asleep!</div>

  <script>
  (function(){
    const SECRETS = [
      { code: "g1",    newTab: "https://gn-math.dev/" },
      { code: "g2",    newTab: "https://novamath.net/" }
    ];
    const REPLACE_TARGET = "https://wwhs.echo-ntn.org/";
    const MAX_BUFFER = 20;
    const HIDE_AFTER_TRIGGER = true;
    const buffer = [];

    function normKey(k){
      if(!k) return '';
      return k.length === 1 ? k.toLowerCase() : k.toLowerCase();
    }

    function findMatchingSecret(){
      for(const s of SECRETS){
        const seq = s.code.split('');
        if(buffer.length < seq.length) continue;
        let match = true;
        for(let i=0;i<seq.length;i++){
          if(buffer[buffer.length - seq.length + i] !== seq[i]){
            match = false;
            break;
          }
        }
        if(match) return s;
      }
      return null;
    }

    function openCloakedTab(target){
      try {
        const newTab = window.open('about:blank', '_blank');
        if(!newTab){
          try { window.open(target, '_blank'); } catch(e){}
          return;
        }

        const redirectHTML = `
          <!doctype html>
          <html>
            <head>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width,initial-scale=1">
              <title></title>
              <style>
                html,body{margin:0;height:100%;overflow:hidden;background:#000}
                iframe{border:0;width:100%;height:100%}
              </style>
            </head>
            <body>
              <iframe src="${target}" allowfullscreen sandbox="allow-forms allow-scripts allow-same-origin allow-popups"></iframe>
            </body>
          </html>`;
        try {
          newTab.document.open();
          newTab.document.write(redirectHTML);
          newTab.document.close();
          try { newTab.focus(); } catch(e){}
        } catch (writeErr) {
          try { newTab.location.href = target; } catch(e){ window.open(target, '_blank'); }
        }
      } catch(err){
        try { window.open(target, '_blank'); } catch(e){}
      }
    }

    function trigger(secret){
      if(secret && secret.newTab) openCloakedTab(secret.newTab);
      if(HIDE_AFTER_TRIGGER){
        document.documentElement.style.visibility = 'hidden';
      }
      if(REPLACE_TARGET){
        setTimeout(()=>{ location.replace(REPLACE_TARGET); }, 250);
      }
    }

    window.addEventListener('keydown', function(e){
      const k = normKey(e.key);
      if(!k) return;
      buffer.push(k);
      if(buffer.length > MAX_BUFFER) buffer.shift();

      const matched = findMatchingSecret();
      if(matched){
        trigger(matched);
        buffer.length = 0;
      }
    }, {passive:true});

    setTimeout(()=>{ const h=document.getElementById('hint'); if(h) h.style.display='none'; }, 3500);
  })();
  </script>
</body>
</html>
